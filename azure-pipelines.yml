trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  name: 'Default'
  demands:
    - agent.os -equals Windows_NT

steps:
  - checkout: self
    fetchDepth: 2

  - script: |
      echo "ðŸ“˜ Leyendo archivo de mapeo docs_map.yml..."

      # Convertimos el YAML en pares clave:valor usando awk
      declare -A map

      while IFS=":" read -r key value; do
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)
        if [[ -n "$key" && -n "$value" ]]; then
          map["$key"]="$value"
        fi
      done < docs_map.yml

      echo "ðŸ” Notebooks a vigilar:"
      printf '%s\n' "${!map[@]}"

      changed_files=$(git diff --name-only HEAD^ HEAD)

      echo "ðŸ“„ Ficheros modificados:"
      echo "$changed_files"

      missing_docs=0

      for nb in "${!map[@]}"; do
        if echo "$changed_files" | grep -q "^$nb$"; then
          doc=${map[$nb]}
          echo "ðŸ“Œ Notebook modificado: $nb"
          echo "ðŸ“Œ Doc esperada: $doc"

          if ! echo "$changed_files" | grep -q "^$doc$"; then
            echo "âŒ ERROR: El notebook '$nb' cambiÃ³, pero la documentaciÃ³n '$doc' NO se modificÃ³."
            missing_docs=1
          else
            echo "âœ” La documentaciÃ³n '$doc' tambiÃ©n cambiÃ³."
          fi
        fi
      done

      if [ "$missing_docs" -eq 1 ]; then
        echo "âŒ Falta documentaciÃ³n actualizada. Pipeline fallarÃ¡."
        exit 1
      fi

      echo "âœ” Todo correcto."
    displayName: "Validar documentaciÃ³n con docs_map.yml"
