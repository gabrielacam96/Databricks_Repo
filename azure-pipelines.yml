trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  name: 'Default'


steps:
  - checkout: self
    fetchDepth: 2

  - bash: |
        echo "========================================"
        echo "ðŸ› MODO DEPURACIÃ“N ACTIVADO"
        echo "========================================"

        # 1. Carga del Mapa
        declare -A map
        if [ ! -f docs_map.yml ]; then
          echo "âŒ Error: No encuentro docs_map.yml"
          exit 1
        fi

        echo "ðŸ“‚ 1. Contenido detectado en docs_map.yml:"
        while IFS=":" read -r key value; do
          # Limpieza agresiva de espacios y comillas
          key=$(echo "$key" | tr -d ' "' | tr -d "'")
          value=$(echo "$value" | tr -d ' "' | tr -d "'")
          
          # Ignoramos comentarios
          if [[ -n "$key" && -n "$value" && "$key" != \#* ]]; then
            map["$key"]="$value"
            echo "   -> [MAPA] Clave: '$key' | Valor: '$value'"
          fi
        done < docs_map.yml

        echo "----------------------------------------"

        # 2. DetecciÃ³n de cambios en Git
        # Aseguramos que git use formato estÃ¡ndar
        changed_files=$(git diff --name-only HEAD^ HEAD)
        
        echo "change files: $changed_files"

        echo "ðŸ™ 2. Archivos que Git dice que cambiaron:"
        if [ -z "$changed_files" ]; then
          echo "   (NingÃºn archivo detectado. Â¿QuizÃ¡s es el primer commit?)"
        else
          while read -r file; do
              echo "   -> [GIT]  '$file'"
          done <<< "$changed_files"
        fi

        echo "----------------------------------------"
        echo "ðŸ” 3. Comparando (Buscando coincidencias exactas)..."

        missing_docs=0

        for nb in "${!map[@]}"; do
          echo "   ... Revisando si el notebook '$nb' estÃ¡ en los cambios de Git..."
          
          # Usamos grep -F (Fixed string) para evitar problemas con sÃ­mbolos raros
          if echo "$changed_files" | grep -F -q "$nb"; then
              echo "   âœ… Â¡COINCIDENCIA ENCONTRADA! El notebook '$nb' fue modificado."
              
              doc=${map[$nb]}
              echo "      Verificando su documentaciÃ³n: '$doc'"

              if ! echo "$changed_files" | grep -F -q "$doc"; then
                  echo "      âŒ ERROR: La documentaciÃ³n '$doc' NO aparece en la lista de cambios."
                  missing_docs=1
              else
                  echo "      âœ” La documentaciÃ³n tambiÃ©n se modificÃ³. Correcto."
              fi
          else
              echo "      (No coincide. Git tiene otras rutas o no se tocÃ³ este archivo)"
          fi
        done

        echo "----------------------------------------"
        if [ "$missing_docs" -eq 1 ]; then
          echo "ðŸ”´ RESULTADO: FALLO. Falta documentaciÃ³n."
          exit 1
        fi

        echo "ðŸŸ¢ RESULTADO: Ã‰XITO. Todo correcto."
        exit 0

        displayName: "ValidaciÃ³n con DEBUG"
        env:
          PATH: "C:\\Program Files\\Git\\bin;$(PATH)"
