trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  name: 'Default'


steps:
  - checkout: self
    fetchDepth: 0

  - bash: |
        echo "----------------------------------------"
        echo "üìò Verificando cambios en el √öLTIMO COMMIT"
        echo "----------------------------------------"

        # 1. Cargar mapa (igual que antes)
        if [ ! -f docs_map.yml ]; then
          echo "‚ö†Ô∏è  No se encontr√≥ docs_map.yml."
          exit 0
        fi

        declare -A map
        while IFS=":" read -r key value; do
          key=$(echo "$key" | tr -d ' "' | tr -d "'")
          value=$(echo "$value" | tr -d ' "' | tr -d "'")
          if [[ -n "$key" && -n "$value" && "$key" != \#* ]]; then
            map["$key"]="$value"
          fi
        done < docs_map.yml

        # 2. DETECTAR CAMBIOS (Misma rama: Actual vs Anterior)
        # HEAD  = Tu versi√≥n actual
        # HEAD^ = La versi√≥n justo antes de tu commit
        
        echo "üîç Ejecutando: git diff --name-only HEAD^ HEAD"
        changed_files=$(git diff --name-only HEAD^ HEAD)

        # Si sale vac√≠o, intentamos una alternativa por si es un merge commit
        if [ -z "$changed_files" ]; then
          echo "‚ö†Ô∏è  La lista sali√≥ vac√≠a. Probando con HEAD~1..."
          changed_files=$(git diff --name-only HEAD~1 HEAD)
        fi

        echo "üìÑ Archivos modificados detectados:"
        echo "$changed_files"
        echo "----------------------------------------"

        if [ -z "$changed_files" ]; then
          echo "‚ö†Ô∏è  ATENCI√ìN: Git no reporta ning√∫n archivo modificado."
          echo "    Posible causa: El commit est√° vac√≠o o es un merge sin cambios de ficheros."
          exit 0
        fi

        missing_docs=0

        # 3. Validar
        for nb in "${!map[@]}"; do
          # grep -F busca texto exacto (sin interpretar s√≠mbolos raros)
          if echo "$changed_files" | grep -F -q "$nb"; then
            doc=${map[$nb]}
            echo "‚ö†Ô∏è  Notebook modificado: $nb"

            if ! echo "$changed_files" | grep -F -q "$doc"; then
              echo "‚ùå ERROR: Falta actualizar la documentaci√≥n ($doc)."
              missing_docs=1
            else
              echo "‚úÖ Documentaci√≥n OK."
            fi
            echo "---"
          fi
        done

        if [ "$missing_docs" -eq 1 ]; then
          echo "üî¥ BLOQUEO: Faltan documentaciones."
          exit 1
        fi

        echo "üü¢ Todo correcto."
        exit 0

    displayName: "Validar √∫ltimo commit"
    env:
      PATH: "C:\\Program Files\\Git\\bin;$(PATH)"
